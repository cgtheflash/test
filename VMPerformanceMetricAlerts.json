{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "memoryAlertName": {
            "defaultValue": "All VMs Percentage Memory Utilization",
            "type": "String"
        },
        "memoryAlertThreshold": {
            "defaultValue": 80,
            "type": "int",
            "metadata": {
                "description": "Threshold for the Memory Alert. For example, a value of 80 means this will alert if the memory usage exceeds 80 percent."
            },
            "minValue": 0,
            "maxValue": 100
        },
        "diskAlertName": {
            "defaultValue": "All VMs Logical Disks Free Space Percentage",
            "type": "String"
        },
        "diskAlertThreshold": {
            "defaultValue": 10,
            "type": "int",
            "metadata": {
                "description": "Threshold for the Disk Alert. For example, a value of 10 means this will alert if the free space on a logical disk is less than 10 percent."
            },
            "minValue": 0,
            "maxValue": 100
        },
        "cpuAlertName": {
            "defaultValue": "All VMs Percentage CPU Utilization",
            "type": "String"
        },
        "cpuAlertThreshold": {
            "defaultValue": 80,
            "type": "int",
            "metadata": {
                "description": "Threshold for the CPU Alert. For example, a value of 80 means this will alert if the CPU usage exceeds 80 percent."
            },
            "minValue": 0,
            "maxValue": 100
        },
        "actionGroupId": {
            "defaultValue": "/subscriptions/1f1408b2-11a5-4921-834e-61ce068fd933/resourceGroups/HF-mgmt/providers/microsoft.insights/actiongroups/ActivityLogAlerts",
            "type": "String"
        },
        "logAnalyticsWorkspaceId": {
            "defaultValue": "/subscriptions/1f1408b2-11a5-4921-834e-61ce068fd933/resourcegroups/hf-mgmt/providers/microsoft.operationalinsights/workspaces/hf-la-1f1408b2-11a5-4921-834e-61ce068fd933",
            "type": "String"
        }
    },
    "variables": {},
    "resources": [
        {
            "type": "microsoft.insights/scheduledqueryrules",
            "apiVersion": "2020-05-01-preview",
            "name": "[parameters('cpuAlertName')]",
            "location": "Global",
            "properties": {
                "displayName": "[parameters('cpuAlertName')]",
                "description": "[concat('Alert on CPU percentage utilization exceeding', parameters('cpuAlertThreshold'), 'percent.')]",
                "severity": 3,
                "enabled": true,
                "evaluationFrequency": "PT5M",
                "windowSize": "PT5M",
                "scopes": [
                    "[parameters('logAnalyticsWorkspaceId')]"
                ],
                "criteria": {
                    "allOf": [
                        {
                            "query": "InsightsMetrics\n| where Origin == \"vm.azm.ms\" \n| where Namespace == \"Processor\" and Name == \"UtilizationPercentage\" \n| summarize AggregatedValue = avg(Val) by bin(TimeGenerated, 15m), Computer, _ResourceId",
                            "timeAggregation": "Average",
                            "metricMeasureColumn": "AggregatedValue",
                            "dimensions": [
                                {
                                    "name": "Computer",
                                    "operator": "Include",
                                    "values": [
                                        "*"
                                    ]
                                }
                            ],
                            "operator": "GreaterThan",
                            "threshold": "[parameters('cpuAlertThreshold')]",
                            "failingPeriods": {
                                "numberOfEvaluationPeriods": 1,
                                "minFailingPeriodsToAlert": 1
                            }
                        }
                    ]
                },
                "actions": [
                    {
                        "actionGroupId": "[parameters('actionGroupId')]"
                    }
                ]
            }
        },
        {
            "type": "microsoft.insights/scheduledqueryrules",
            "apiVersion": "2020-05-01-preview",
            "name": "[parameters('diskAlertName')]",
            "location": "Global",
            "properties": {
                "displayName": "[parameters('diskAlertName')]",
                "description": "[concat('Alert on logical disk free space falling below', parameters('diskAlertThreshold'), 'percent.')]",
                "severity": 3,
                "enabled": true,
                "evaluationFrequency": "PT5M",
                "windowSize": "PT5M",
                "scopes": [
                    "[parameters('logAnalyticsWorkspaceId')]"
                ],
                "criteria": {
                    "allOf": [
                        {
                            "query": "InsightsMetrics\n| where Origin == \"vm.azm.ms\"\n| where Namespace == \"LogicalDisk\" and Name == \"FreeSpacePercentage\"\n| extend Disk=tostring(todynamic(Tags)[\"vm.azm.ms/mountId\"])\n| summarize AggregatedValue = avg(Val) by bin(TimeGenerated, 15m), Computer, _ResourceId, Disk",
                            "timeAggregation": "Average",
                            "metricMeasureColumn": "AggregatedValue",
                            "dimensions": [
                                {
                                    "name": "Computer",
                                    "operator": "Include",
                                    "values": [
                                        "*"
                                    ]
                                }
                            ],
                            "operator": "LessThan",
                            "threshold": "[parameters('diskAlertThreshold')]",
                            "failingPeriods": {
                                "numberOfEvaluationPeriods": 1,
                                "minFailingPeriodsToAlert": 1
                            }
                        }
                    ]
                },
                "actions": [
                    {
                        "actionGroupId": "[parameters('actionGroupId')]"
                    }
                ]
            }
        },
        {
            "type": "microsoft.insights/scheduledqueryrules",
            "apiVersion": "2020-05-01-preview",
            "name": "[parameters('memoryAlertName')]",
            "location": "Global",
            "properties": {
                "displayName": "[parameters('memoryAlertName')]",
                "description": "[concat('Alert on memory percentage utilization exceeding', parameters('memoryAlertThreshold'), 'percent.')]",
                "severity": 3,
                "enabled": true,
                "evaluationFrequency": "PT5M",
                "windowSize": "PT5M",
                "scopes": [
                    "[parameters('logAnalyticsWorkspaceId')]"
                ],
                "criteria": {
                    "allOf": [
                        {
                            "query": "InsightsMetrics \n| where Origin == \"vm.azm.ms\" \n| where Namespace == \"Memory\" and Name == \"AvailableMB\" \n| extend TotalMemory = toreal(todynamic(Tags)[\"vm.azm.ms/memorySizeMB\"])\n| extend AvailableMemoryPercentage = (toreal(Val) / TotalMemory) * 100.0 \n| summarize AggregatedValue = avg(AvailableMemoryPercentage) by bin(TimeGenerated, 15m), Computer, _ResourceId",
                            "timeAggregation": "Average",
                            "metricMeasureColumn": "AggregatedValue",
                            "dimensions": [
                                {
                                    "name": "Computer",
                                    "operator": "Include",
                                    "values": [
                                        "*"
                                    ]
                                }
                            ],
                            "operator": "GreaterThan",
                            "threshold": "[parameters('memoryAlertThreshold')]",
                            "failingPeriods": {
                                "numberOfEvaluationPeriods": 1,
                                "minFailingPeriodsToAlert": 1
                            }
                        }
                    ]
                },
                "actions": [
                    {
                        "actionGroupId": "[parameters('actionGroupId')]"
                    }
                ]
            }
        }
    ]
}